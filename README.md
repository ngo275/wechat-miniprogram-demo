# WeChat Mini Program 微信小程序

## ドキュメント

### 英語
https://github.com/apelegri/wechat-mini-program-wiki

### 中国語
https://developers.weixin.qq.com/miniprogram/dev/

## 概要
WeChat上に載せられる簡易的なアプリのこと。JSとHTML、CSSで作成できる。JSといってもほとんどVue.jsに近い。

## デベロッパー用の管理画面
https://mp.weixin.qq.com

まずデベロッパーのアカウントを作成する必要がある。ただし、 __中国大陸以外の人は個人でアカウントを作ることができない__ ことに注意。したがって、日本法人用のアカウントを作って(登録するアドレスもパスワードも共有する前提なので個人のものではないほうが良い)、その後、自分のWeChatアカウントとデベロッパーアカウントを紐付けることになる。デベロッパーアカウントとWeChatアカウントが別物であることに注意。登録済みの管理人は、デベロッパー追加画面で、他の人を招待することができ、これは同じデベロッパーアカウントに複数のWeChatアカウントを紐づけているに過ぎない。ここで招待された人も最初に登録で使ったメールアドレスとパスワードでログインするのだが、その後に出てくるQR読み取り画面では招待されているWeChatアカウントで認証される。

この登録をしなくてもIDE上でテストアカウントを発行すれば開発自体はある程度は可能なのでスキップしても良い。日本法人がない場合は、中国人の友達に、デベロッパーアカウントを作ってもらって(メールアドレスとパスワードは共有される前提なので注意)、デベロッパー追加してもらって、メールアドレスとパスワードを共有してもらうのが良いかもしれない。

## 微信开发者工具(ミニプログラム用のIDE)
https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

ミニプログラムの開発にはTencentが開発しているIDEを利用することになる。これを使うとテストアカウントを発行して開発することもできるので、デベロッパー登録は後回しにできる。しかし、その場合はプラグインの導入ができないなどの制約がある。

## ICPライセンス
中国大陸でウェブサービスを提供するためには、[ICPライセンス](https://www.clara.jp/consulting/icp/lp/#section07)が必要になる。ウェブサービスとはいえ、APIサーバを大陸内に置く場合も同様である。このライセンスには経営性と非経営性があり、前者は取得に一年とかかかることもあり、後者は数日からせいぜい数週間で取れる。

ミニプログラムは海外の法人も作成可能だが、事業内容によってはICPライセンスの取得が必要になるので注意が必要だ。

ミニプログラムでは利用しているAPIのエンドポイントのドメインを管理画面で登録する必要がある。開発時はドメインチェックのフラグをオフにしておくとよいだろう。 `project.config.json` の `urlCheck` を `false` にする。

```json
"setting": {
	"urlCheck": false,
	"es6": true,
	"postcss": true,
	"minified": true,
	"newFeature": true,
	"nodeModules": false,
	"autoAudits": false
}
```

## データの保持

### 永続化
公式でおすすめされているサービス。ただし、 __中国大陸の電話番号が必要__ 。

https://leancloud.cn/

### キャッシュ
WeChat側のAPIでキャッシュの仕組みが提供されている。KVSで、iOSでいうところのUserDefaultsに近い。

## WeChat API

以下の機能がWeChatのミニプログラムで提供されており、 `wx.getUserInfo` のように `wx` オブジェクト内に入っている。

- ユーザ情報取得機能
- データのキャッシュ機能
- QRコード読み取り機能
- 位置情報取得機能
- 画像の取扱（保存等）機能

## Plug-inの利用
ミニプログラムではプラグインを利用することで外部が提供している機能を利用できる。そのためにはまず、管理画面で、プラグインのIDを追加する必要がある。

たとえば `tencentvideo` というプラグインを追加するのであれば、 `wxa75efa648b60994b` を追加する。

その後、 `app.json` に以下のように追記する。

```json
  "plugins": {
    "tencentvideo": {
      "version": "1.2.3",
      "provider": "wxa75efa648b60994b"
    }
  }
```


## TODO

海外法人アカウントで作成する場合の制約について、WeChat Payが使えない？とかの調査をする。